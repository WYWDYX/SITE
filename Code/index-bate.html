<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代码编辑器</title>
    <link rel="icon" type="image/svg" href="../Assets/Images/Logo - Square.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'JetBrainsMono', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --header-height: 60px;
            --status-bar-height: 22px;
            --tab-height: 36px;
            --sidebar-width: 300px;
            --activity-bar-width: 50px;
            --primary-color: #1c6beb;
            --secondary-color: #238636;
            --bg-color: #0d1117;
            --sidebar-bg: #161b22;
            --activity-bar-bg: #161b22;
            --tab-bg: #1c2128;
            --tab-active-bg: #0d1117;
            --status-bar-bg: #007acc;
            --text-color: #c9d1d9;
            --border-color: #30363d;
        }
        
        :root[data-theme="light"] {
            --bg-color: #ffffff;
            --sidebar-bg: #f3f3f3;
            --activity-bar-bg: #e8e8e8;
            --tab-bg: #f3f3f3;
            --tab-active-bg: #ffffff;
            --status-bar-bg: #007acc;
            --text-color: #333333;
            --border-color: #cccccc;
        }
        
        a {
            -webkit-tap-highlight-color: transparent;
        }
        
        li {
            -webkit-tap-highlight-color: transparent;
        }
        
        button {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* 活动栏样式 */
        .activity-bar {
            width: var(--activity-bar-width);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            border-right: 1px solid var(--border-color);
        }
        
        .activity-item {
            width: 100%;
            padding: 12px 0;
            text-align: center;
            cursor: pointer;
            color: #8b949e;
            transition: all 0.2s ease;
            position: relative;
        }
        
        #explorer {
            display: none;
        }
        
        .activity-item.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .activity-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 2px;
            background-color: var(--primary-color);
        }
        
        .activity-item:hover {
            color: white;
        }
        
        .activity-item i {
            font-size: 20px;
        }
        
        /* 文件导航样式 */
        .file-navigator {
            width: var(--sidebar-width);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: transform 0.3s ease;
        }
        
        .nav-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .folder-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
            white-space: nowrap;
            overflow: scroll;
        }
        
        .folder-name::-webkit-scrollbar {
            display: none;
        }
        
        .nav-actions {
            display: flex;
            gap: 10px;
        }
        
        .nav-action-btn {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 14px;
            transition: color 0.2s ease;
        }
        
        .nav-action-btn:hover {
            color: var(--text-color);
        }
        
        #newFileBtn {
            margin-left: 10px;
        }
        
        .file-list-container {
            overflow-y: auto;
            flex: 1;
            padding: 8px;
        }
        
        .file-list {
            list-style: none;
        }
        
        .file-item {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease, transform 0.2s ease;
            user-select: none;
        }
        
        .file-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }
        
        .file-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .file-icon {
            margin-right: 8px;
            font-size: 14px;
            width: 16px;
            text-align: center;
        }
        
        .file-item span {
            overflow: scroll;
        }
        
        .file-item span::-webkit-scrollbar {
            display: none;
        }
        
        /* 版权信息 */
        .navigator-footer {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: #8b949e;
            text-align: center;
            flex-shrink: 0;
            transition: color 0.3s ease;
        }
        
        .navigator-footer:hover {
            color: var(--text-color);
        }
        
        /* 主内容区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            height: 100%;
            overflow: hidden;
        }
        
        /* 标签栏样式 */
        .tabs-container {
            display: flex;
            background-color: var(--tab-bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            flex-shrink: 0;
            height: var(--tab-height);
        }
        
        .tab {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            min-width: 160px;
            max-width: 240px;
            border-right: 1px solid var(--border-color);
            background-color: var(--tab-bg);
            transition: background-color 0.2s ease;
            position: relative;
        }
        
        .tab.active {
            background-color: var(--tab-active-bg);
        }
        
        .tab-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }
        
        .tab-close {
            margin-left: auto;
            padding: 2px;
            border-radius: 2px;
            transition: background-color 0.2s ease;
        }
        
        .tab-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .tab-dirty::before {
            content: '●';
            color: #f85149;
            margin-right: 4px;
            font-size: 12px;
        }
        
        /* 代码显示区域样式 */
        .code-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            height: var(--header-height);
        }
        
        .current-file {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: auto;
            flex: 1;
        }
        
        .current-file::-webkit-scrollbar {
            display: none;
        }
        
        .error {
            padding: 65px;
            text-align: center;
            color: #f85149;
        }
        
        .error i {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .editor-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .editor-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        
        .editor-btn:hover {
            background-color: #2ea043;
            transform: scale(1.05);
        }
        
        .editor-btn.edit-mode {
            background-color: var(--primary-color);
        }
        
        .editor-btn.edit-mode:hover {
            background-color: #2266d9;
        }
        
        .editor-btn.view-mode {
            background-color: #8b949e;
        }
        
        .editor-btn.view-mode:hover {
            background-color: #6e7681;
        }
        
        .code-content {
            flex: 1;
            overflow: hidden;
            height: calc(100vh - var(--header-height) - var(--tab-height) - 20px);
            position: relative;
        }
        
        #monaco-editor {
            width: 100%;
            height: 100%;
        }
        
        /* 状态栏样式 */
        .status-bar {
            height: var(--status-bar-height);
            background-color: var(--status-bar-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            font-size: 12px;
            color: white;
            flex-shrink: 0;
        }
        
        .status-left, .status-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-item {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }
        
        .status-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 搜索面板样式 */
        .search-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            backdrop-filter: blur(10px);
            border-left: 1px solid var(--border-color);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        
        .search-panel.active {
            transform: translateX(0);
        }
        
        .search-header {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-input-container {
            position: relative;
            margin-bottom: 10px;
        }
        
        .search-input {
            width: 100%;
            padding: 6px 30px 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .search-input-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #8b949e;
        }
        
        .replace-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin-bottom: 10px;
        }
        
        .search-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .search-option {
            display: flex;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .search-option input {
            margin-right: 4px;
        }
        
        .search-actions {
            display: flex;
            gap: 5px;
        }
        
        .search-btn {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            font-size: 12px;
        }
        
        .search-btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .search-result-item {
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .search-result-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .file-navigator {
                position: fixed;
                top: 0;
                left: 0;
                height: calc(100% - var(--activity-bar-width));
                z-index: 90;
                transform: translateX(-100%);
                width: 80%;
                max-width: 300px;
            }
        
            .file-navigator.active {
                transform: translateX(0);
            }
        
            .activity-bar {
                position: fixed;
                left: 0;
                bottom: 0;
                height: var(--activity-bar-width);
                width: 100%;
                flex-direction: row;
                z-index: 80;
                border-right: none;
                border-top: 1px solid var(--border-color);
            }
        
            .activity-item {
                padding: 12px;
            }
            
            #explorer {
                display: block;
            }
        
            .activity-item.active::before {
                width: 100%;
                height: 2px;
                top: auto;
                bottom: 0;
            }
        
            .editor-actions {
                gap: 4px;
            }
        
            .editor-btn {
                padding: 4px 8px;
                font-size: 12px;
            }
            
            .code-content {
                height: calc(100vh - var(--header-height) - var(--activity-bar-width) - var(--tab-height) - 20px);
            }
        
            .search-panel {
                width: 80%;
                height: calc(100% - var(--activity-bar-width));
            }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #161b22;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #30363d;
            transition: background 0.3s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #8b949e;
        }
        
        @font-face {
            font-family: 'JetBrainsMono';
            src: url('../Assets/Font/JetBrainsMono-Medium.woff2') format('woff2');
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--secondary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.error {
            background-color: #f85149;
        }
        
        /* 主题切换按钮 */
        .theme-toggle {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 16px;
            transition: color 0.2s ease;
        }
        
        .theme-toggle:hover {
            color: var(--text-color);
        }
        
        /* 右键菜单 */
        .context-menu {
            position: fixed;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 150px;
            display: none;
        }
        
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s ease;
        }
        
        .context-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .context-menu-item i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }
        
        /* 命令面板 */
        .command-palette {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            max-width: 90%;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .command-input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            font-size: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .command-input:focus {
            outline: none;
        }
        
        .command-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .command-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .command-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .command-item i {
            margin-right: 10px;
            width: 16px;
            text-align: center;
        }
        
        .command-title {
            font-weight: 500;
        }
        
        .command-desc {
            font-size: 12px;
            color: #8b949e;
            margin-left: auto;
        }
        
        .command-item.active .command-desc {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
    </style>
</head>

<body>
    <div class="overlay" id="overlay"></div>

    <div class="container">
        <!-- 活动栏 -->
        <div class="activity-bar">
            <div class="activity-item" data-view="explorer" id="explorer" title="资源管理器">
                <i class="fas fa-folder-open"></i>
            </div>
            <div class="activity-item active" data-view="code" title="代码编辑器">
                <i class="fa-solid fa-code"></i>
            </div>
            <div class="activity-item" data-view="search" title="搜索">
                <i class="fas fa-search"></i>
            </div>
        </div>

        <!-- 文件导航 -->
        <div class="file-navigator" id="fileNavigator">
            <div class="nav-header">
                <div class="folder-name" id="folderName">加载中...</div>
                <div class="nav-actions">
                    <button class="nav-action-btn" id="newFileBtn" title="新建文件">
                        <i class="fas fa-file"></i>
                    </button>
                    <button class="nav-action-btn" id="newFolderBtn" title="新建文件夹">
                        <i class="fas fa-folder"></i>
                    </button>
                    <button class="nav-action-btn" id="refreshBtn" title="刷新">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="file-list-container">
                <ul class="file-list" id="fileList"></ul>
            </div>
            <div class="navigator-footer">© 2025 wywdyx</div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 标签栏 -->
            <div class="tabs-container" id="tabsContainer"></div>

            <!-- 代码显示区域 -->
            <div class="code-display">
                <div class="code-header">
                    <div class="current-file" id="currentFile">
                        选择文件查看代码
                    </div>
                    <div class="editor-actions">
                        <button class="editor-btn" id="findButton" title="查找">
                            <i class="fas fa-search"></i> 查找
                        </button>
                        <button class="editor-btn edit-mode" id="toggleModeButton">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="editor-btn" id="saveButton" title="保存 (Ctrl+S)" style="display: none;">
                            <i class="fas fa-save"></i> 保存
                        </button>
                        <button class="editor-btn" id="copyButton">
                            <i class="far fa-copy"></i> 复制
                        </button>
                        <button class="theme-toggle" id="themeToggle" title="切换主题">
                            <i class="fas fa-moon"></i>
                        </button>
                    </div>
                </div>
                <div class="code-content" id="codeContent">
                    <div class="loading" id="loadingIndicator">
                        <div class="spinner"></div>
                    </div>
                    <div id="monaco-editor"></div>
                </div>
            </div>

            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="status-left">
                    <span class="status-item" id="cursorPosition">第1行, 第1列</span>
                    <span class="status-item" id="encoding">UTF-8</span>
                    <span class="status-item" id="lineEnding">LF</span>
                    <span class="status-item" id="language">纯文本</span>
                </div>
                <div class="status-right">
                    <span class="status-item" id="toggleSidebarBtn" title="切换侧边栏">
                        <i class="fas fa-bars"></i>
                    </span>
                </div>
            </div>
        </div>

        <!-- 搜索面板 -->
        <div class="search-panel" id="searchPanel">
            <div class="search-header">
                <div class="search-input-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="搜索">
                    <span class="search-input-icon">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
                <div>
                    <input type="text" class="replace-input" id="replaceInput" placeholder="替换">
                </div>
                <div class="search-options">
                    <label class="search-option">
                        <input type="checkbox" id="caseSensitive"> 区分大小写
                    </label>
                    <label class="search-option">
                        <input type="checkbox" id="wholeWord"> 全字匹配
                    </label>
                    <label class="search-option">
                        <input type="checkbox" id="useRegex"> 使用正则表达式
                    </label>
                </div>
                <div class="search-actions">
                    <button class="search-btn" id="replaceBtn">替换</button>
                    <button class="search-btn" id="replaceAllBtn">全部替换</button>
                    <button class="search-btn primary" id="searchBtn">查找</button>
                </div>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="newFile">
            <i class="fas fa-file"></i> 新建文件
        </div>
        <div class="context-menu-item" data-action="newFolder">
            <i class="fas fa-folder"></i> 新建文件夹
        </div>
        <div class="context-menu-item" data-action="rename">
            <i class="fas fa-i-cursor"></i> 重命名
        </div>
        <div class="context-menu-item" data-action="delete">
            <i class="fas fa-trash"></i> 删除
        </div>
    </div>

    <!-- 命令面板 -->
    <div class="command-palette" id="commandPalette">
        <input type="text" class="command-input" id="commandInput" placeholder="输入命令名称或搜索命令">
        <div class="command-list" id="commandList">
            <div class="command-item" data-command="file.newFile">
                <i class="fas fa-file"></i>
                <span class="command-title">新建文件</span>
                <span class="command-desc">Ctrl+N</span>
            </div>
            <div class="command-item" data-command="file.save">
                <i class="fas fa-save"></i>
                <span class="command-title">保存</span>
                <span class="command-desc">Ctrl+S</span>
            </div>
            <div class="command-item" data-command="editor.toggleTheme">
                <i class="fas fa-moon"></i>
                <span class="command-title">切换主题</span>
                <span class="command-desc"></span>
            </div>
            <div class="command-item" data-command="view.toggleSidebar">
                <i class="fas fa-bars"></i>
                <span class="command-title">切换侧边栏</span>
                <span class="command-desc">Ctrl+B</span>
            </div>
            <div class="command-item" data-command="search.find">
                <i class="fas fa-search"></i>
                <span class="command-title">查找</span>
                <span class="command-desc">Ctrl+F</span>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const fileNavigator = document.getElementById('fileNavigator');
            const fileList = document.getElementById('fileList');
            const folderName = document.getElementById('folderName');
            const currentFile = document.getElementById('currentFile');
            const codeContent = document.getElementById('codeContent');
            const copyButton = document.getElementById('copyButton');
            const toggleModeButton = document.getElementById('toggleModeButton');
            const saveButton = document.getElementById('saveButton');
            const findButton = document.getElementById('findButton');
            const explorer = document.getElementById('explorer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const toast = document.getElementById('toast');
            const themeToggle = document.getElementById('themeToggle');
            const searchPanel = document.getElementById('searchPanel');
            const searchInput = document.getElementById('searchInput');
            const replaceInput = document.getElementById('replaceInput');
            const searchBtn = document.getElementById('searchBtn');
            const replaceBtn = document.getElementById('replaceBtn');
            const replaceAllBtn = document.getElementById('replaceAllBtn');
            const searchResults = document.getElementById('searchResults');
            const contextMenu = document.getElementById('contextMenu');
            const tabsContainer = document.getElementById('tabsContainer');
            const activityItems = document.querySelectorAll('.activity-item');
            const newFileBtn = document.getElementById('newFileBtn');
            const newFolderBtn = document.getElementById('newFolderBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const cursorPosition = document.getElementById('cursorPosition');
            const encoding = document.getElementById('encoding');
            const lineEnding = document.getElementById('lineEnding');
            const language = document.getElementById('language');
            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            const commandPalette = document.getElementById('commandPalette');
            const commandInput = document.getElementById('commandInput');
            const commandList = document.getElementById('commandList');
            const overlay = document.getElementById('overlay');
        
            let editor = null;
            let isEditMode = false;
            let currentTheme = 'dark';
            let currentFiles = [];
            let currentFolder = '';
            let activeTabId = null;
            let tabs = {};
            let virtualFileSystem = {};
        
            // 初始化虚拟文件系统
            function initVirtualFileSystem() {
                const savedFS = localStorage.getItem('editor_virtual_fs');
                if (savedFS) {
                    virtualFileSystem = JSON.parse(savedFS);
                } else {
                    // 初始化默认文件结构
                    virtualFileSystem = {
                        'welcome': {
                            'type': 'folder',
                            'children': {
                                'README.md': {
                                    'type': 'file',
                                    'content': '# 欢迎使用代码编辑器\n\n这是一个基于浏览器的代码编辑器，支持多种编程语言。\n\n## 功能特点\n- 语法高亮\n- 多标签页编辑\n- 搜索和替换\n- 主题切换\n- 虚拟文件系统\n\n使用URL参数可以加载服务器上的文件，例如：?F=文件夹名称-文件1,文件2,文件3'
                                },
                                'example.js': {
                                    'type': 'file',
                                    'content': '// JavaScript示例\nfunction greet(name) {\n  return `Hello, ${name}!`;\n}\n\nconsole.log(greet("World"));'
                                },
                                'example.css': {
                                    'type': 'file',
                                    'content': '/* CSS示例 */\nbody {\n  font-family: Arial, sans-serif;\n  margin: 0;\n  padding: 20px;\n  background-color: #f5f5f5;\n}\n\n.container {\n  max-width: 800px;\n  margin: 0 auto;\n  background-color: white;\n  padding: 20px;\n  border-radius: 8px;\n  box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n}'
                                }
                            }
                        }
                    };
                    saveVirtualFileSystem();
                }
            }
        
            // 保存虚拟文件系统到localStorage
            function saveVirtualFileSystem() {
                localStorage.setItem('editor_virtual_fs', JSON.stringify(virtualFileSystem));
            }
        
            // 解析URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const fileParam = urlParams.get('F');
            
            // 初始化虚拟文件系统
            initVirtualFileSystem();
        
            // 如果没有提供文件参数，使用虚拟文件系统
            if (!fileParam) {
                loadVirtualFileSystem();
                return;
            }
            
            // 解析文件和文件夹名称
            const separatorIndex = fileParam.indexOf('-');
            if (separatorIndex === -1) {
                showError('参数格式不正确', '请使用格式：文件夹名称-文件1,文件2,文件3');
                return;
            }
            
            const folder = fileParam.substring(0, separatorIndex);
            const files = fileParam.substring(separatorIndex + 1).split(',');
            
            if (containsPathTraversal(folder)) {
                showError('安全警告', '文件夹名称包含非法字符');
                return;
            }
            
            for (const file of files) {
                if (containsPathTraversal(file)) {
                    showError('安全警告', '文件名包含非法字符');
                    return;
                }
            }
            
            // 设置文件夹名称
            folderName.textContent = folder;
            currentFolder = folder;
            currentFiles = files;
            
            // 生成文件列表
            renderFileList(files);
            
            // 初始化Monaco Editor
            initMonacoEditor().then(() => {
                // 加载第一个文件
                if (files.length > 0) {
                    openFile(folder, files[0]);
                } else {
                    showEmptyState('没有找到文件', '请在URL参数中提供文件列表');
                }
            }).catch(error => {
                console.error('Monaco Editor初始化失败:', error);
                showError('编辑器加载失败', '无法加载代码编辑器，请刷新页面重试');
            });
            
            // 复制按钮事件
            copyButton.addEventListener('click', () => {
                if (editor) {
                    const code = editor.getValue();
                    navigator.clipboard.writeText(code)
                        .then(() => {
                            showToast('代码已复制到剪贴板');
                        })
                        .catch(err => {
                            console.error('复制失败:', err);
                            showToast('复制失败', true);
                        });
                }
            });
            
            // 模式切换按钮事件
            toggleModeButton.addEventListener('click', () => {
                toggleEditMode();
            });
        
            // 保存按钮事件
            saveButton.addEventListener('click', () => {
                saveCurrentFile();
            });
        
            // 查找按钮事件
            findButton.addEventListener('click', () => {
                searchPanel.classList.toggle('active');
                if (searchPanel.classList.contains('active')) {
                    searchInput.focus();
                }
            });
        
            // 主题切换按钮事件
            themeToggle.addEventListener('click', () => {
                toggleTheme();
            });
        
            // 活动栏项目点击事件
            activityItems.forEach(item => {
                item.addEventListener('click', () => {
                    const view = item.getAttribute('data-view');
                    
                    // 更新活动状态
                    activityItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // 处理不同视图
                    if (view === 'search') {
                        searchPanel.classList.add('active');
                        searchInput.focus();
                    } else {
                        searchPanel.classList.remove('active');
                    }
                });
            });
        
            // 移动端导航切换
            explorer.addEventListener('click', () => {
                fileNavigator.classList.toggle('active');
            });
        
            // 切换侧边栏按钮事件
            toggleSidebarBtn.addEventListener('click', () => {
                fileNavigator.classList.toggle('hidden');
                document.querySelector('.activity-bar').classList.toggle('hidden');
            });
        
            // 点击代码区域外的部分关闭移动端导航
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !fileNavigator.contains(e.target) && 
                    e.target !== explorer &&
                    !explorer.contains(e.target)) {
                    fileNavigator.classList.remove('active');
                }
        
                // 关闭右键菜单
                if (!contextMenu.contains(e.target)) {
                    contextMenu.style.display = 'none';
                }
            });
        
            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                // Ctrl+S - 保存
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (isEditMode) {
                        saveCurrentFile();
                    }
                }
        
                // Ctrl+F - 查找
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    searchPanel.classList.add('active');
                    searchInput.focus();
                }
        
                // Ctrl+N - 新建文件
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    createNewFile();
                }
        
                // Ctrl+B - 切换侧边栏
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    fileNavigator.classList.toggle('hidden');
                    document.querySelector('.activity-bar').classList.toggle('hidden');
                }
        
                // Ctrl+Shift+P - 命令面板
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'P') {
                    e.preventDefault();
                    showCommandPalette();
                }
        
                // ESC - 关闭搜索面板和命令面板
                if (e.key === 'Escape') {
                    if (searchPanel.classList.contains('active')) {
                        searchPanel.classList.remove('active');
                    }
                    if (commandPalette.style.display === 'block') {
                        hideCommandPalette();
                    }
                }
            });
        
            // 文件列表右键菜单
            fileList.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const target = e.target.closest('.file-item');
                if (target) {
                    contextMenu.style.display = 'block';
                    contextMenu.style.top = `${e.pageY}px`;
                    contextMenu.style.left = `${e.pageX}px`;
                }
            });
        
            // 上下文菜单项点击事件
            const contextMenuItems = document.querySelectorAll('.context-menu-item');
            contextMenuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.getAttribute('data-action');
                    handleContextMenuAction(action);
                    contextMenu.style.display = 'none';
                });
            });
        
            // 新建文件按钮事件
            newFileBtn.addEventListener('click', createNewFile);
        
            // 新建文件夹按钮事件
            newFolderBtn.addEventListener('click', createNewFolder);
        
            // 刷新按钮事件
            refreshBtn.addEventListener('click', refreshFileList);
        
            // 搜索按钮事件
            searchBtn.addEventListener('click', performSearch);
        
            // 替换按钮事件
            replaceBtn.addEventListener('click', performReplace);
        
            // 全部替换按钮事件
            replaceAllBtn.addEventListener('click', performReplaceAll);
        
            // 命令面板输入事件
            commandInput.addEventListener('input', filterCommands);
        
            // 命令面板项点击事件
            const commandItems = document.querySelectorAll('.command-item');
            commandItems.forEach(item => {
                item.addEventListener('click', () => {
                    const command = item.getAttribute('data-command');
                    executeCommand(command);
                    hideCommandPalette();
                });
            });
        
            // 检查路径遍历的函数
            function containsPathTraversal(path) {
                return path.includes('../') || path.includes('..\\');
            }
            
            // 初始化Monaco Editor
            function initMonacoEditor() {
                return new Promise((resolve, reject) => {
                    // 配置Monaco Editor
                    require.config({ 
                        paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }
                    });
                    
                    require(['vs/editor/editor.main'], function() {
                        // 创建编辑器实例
                        editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                            value: '// 选择文件开始编辑代码\n',
                            language: 'plaintext',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: true },
                            scrollBeyondLastLine: false,
                            fontSize: 14,
                            lineHeight: 1.5,
                            fontFamily: 'JetBrainsMono, Consolas, "Courier New", monospace',
                            wordWrap: 'on',
                            smoothScrolling: true,
                            formatOnPaste: true,
                            formatOnType: true,
                            suggestOnTriggerCharacters: true,
                            quickSuggestions: true,
                            readOnly: true, // 初始为只读模式
                            renderLineHighlight: 'all',
                            cursorBlinking: 'blink',
                            matchBrackets: 'always',
                            scrollbar: {
                                vertical: 'auto',
                                horizontal: 'auto',
                                useShadows: true
                            },
                            lineNumbers: 'on',
                            folding: true,
                            showFoldingControls: 'mouseover'
                        });
        
                        // 监听光标位置变化
                        editor.onDidChangeCursorPosition((e) => {
                            cursorPosition.textContent = `第${e.position.lineNumber}行, 第${e.position.column}列`;
                        });
        
                        // 监听内容变化
                        editor.onDidChangeModelContent((e) => {
                            if (activeTabId) {
                                const tab = tabs[activeTabId];
                                if (tab && !tab.dirty) {
                                    tab.dirty = true;
                                    updateTabTitle(activeTabId);
                                }
                            }
                        });
                        
                        resolve();
                    }, reject);
                });
            }
            
            // 切换编辑模式
            function toggleEditMode() {
                isEditMode = !isEditMode;
                
                if (editor) {
                    editor.updateOptions({ readOnly: !isEditMode });
                    
                    if (isEditMode) {
                        toggleModeButton.innerHTML = '<i class="fas fa-eye"></i> 只读';
                        toggleModeButton.classList.remove('edit-mode');
                        toggleModeButton.classList.add('view-mode');
                        saveButton.style.display = 'flex';
                        showToast('已切换到编辑模式');
                    } else {
                        toggleModeButton.innerHTML = '<i class="fas fa-edit"></i> 编辑';
                        toggleModeButton.classList.remove('view-mode');
                        toggleModeButton.classList.add('edit-mode');
                        saveButton.style.display = 'none';
                        showToast('已切换到查看模式');
                    }
                }
            }
        
            // 切换主题
            function toggleTheme() {
                currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', currentTheme);
                
                if (editor) {
                    editor.updateOptions({
                        theme: currentTheme === 'dark' ? 'vs-dark' : 'vs'
                    });
                }
                
                themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
                showToast(`已切换到${currentTheme === 'dark' ? '深色' : '浅色'}主题`);
                
                // 保存主题偏好
                localStorage.setItem('editor_theme', currentTheme);
            }
        
            // 加载虚拟文件系统
            function loadVirtualFileSystem() {
                folderName.textContent = '虚拟文件系统';
                currentFolder = 'virtual';
                
                // 获取文件列表
                const files = [];
                for (const folderName in virtualFileSystem) {
                    if (virtualFileSystem[folderName].type === 'folder') {
                        for (const fileName in virtualFileSystem[folderName].children) {
                            files.push(`${folderName}/${fileName}`);
                        }
                    }
                }
                
                currentFiles = files;
                renderFileList(files);
                
                // 初始化Monaco Editor
                initMonacoEditor().then(() => {
                    if (files.length > 0) {
                        openFile('welcome', 'README.md', true);
                    } else {
                        showEmptyState('没有找到文件', '虚拟文件系统中没有文件');
                    }
                }).catch(error => {
                    console.error('Monaco Editor初始化失败:', error);
                    showError('编辑器加载失败', '无法加载代码编辑器，请刷新页面重试');
                });
            }
        
            // 渲染文件列表
            function renderFileList(files) {
                fileList.innerHTML = '';
                
                files.forEach((file, index) => {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.setAttribute('data-file', file);
                    if (index === 0) li.classList.add('active');
                    
                    // 提取文件名
                    const fileName = file.includes('/') ? file.split('/').pop() : file;
                    
                    // 根据文件扩展名设置图标
                    const extension = fileName.split('.').pop().toLowerCase();
                    let iconClass = 'far fa-file';
                    
                    if (['java', 'js', 'py', 'c', 'cpp', 'html', 'css', 'php', 'rb', 'go', 'rs', 'ts'].includes(extension)) {
                        iconClass = 'far fa-file-code';
                    } else if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'ico'].includes(extension)) {
                        iconClass = 'far fa-file-image';
                    } else if (['md', 'txt'].includes(extension)) {
                        iconClass = 'far fa-file-alt';
                    } else if (['zip', 'rar', 'tar', 'gz'].includes(extension)) {
                        iconClass = 'far fa-file-archive';
                    }
                    
                    li.innerHTML = `
                        <i class="file-icon ${iconClass}"></i>
                        <span>${fileName}</span>
                    `;
                    
                    li.addEventListener('click', () => {
                        // 移除所有active类
                        document.querySelectorAll('.file-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // 添加active类到当前项目
                        li.classList.add('active');
                        
                        // 加载文件内容
                        if (file.includes('/')) {
                            const [folder, fileName] = file.split('/');
                            openFile(folder, fileName, true);
                        } else {
                            openFile(currentFolder, file);
                        }
                    });
                    
                    fileList.appendChild(li);
                });
            }
            
            // 打开文件
            function openFile(folder, file, isVirtual = false) {
                // 再次安全检查
                if (containsPathTraversal(folder) || containsPathTraversal(file)) {
                    showError('安全警告', '文件路径包含非法字符，可能存在目录遍历攻击');
                    return;
                }
                
                loadingIndicator.style.display = 'flex';
                currentFile.textContent = file;
                
                const tabId = `${folder}-${file}`;
                
                // 如果文件已经打开，切换到该标签页
                if (tabs[tabId]) {
                    switchToTab(tabId);
                    loadingIndicator.style.display = 'none';
                    return;
                }
                
                // 如果是虚拟文件系统
                if (isVirtual) {
                    try {
                        const fileContent = virtualFileSystem[folder].children[file].content;
                        
                        // 设置编辑器内容
                        if (editor) {
                            const language = getMonacoLanguage(file);
                            editor.setValue(fileContent);
                            monaco.editor.setModelLanguage(editor.getModel(), language);
                            language.textContent = getLanguageName(language);
                        }
                        
                        // 创建新标签页
                        createTab(tabId, folder, file, fileContent);
                        loadingIndicator.style.display = 'none';
                    } catch (error) {
                        showError('加载文件失败', error.message);
                        loadingIndicator.style.display = 'none';
                    }
                    return;
                }
                
                // 构建文件路径
                const filePath = `../Assets/Code/${folder}/${file}`;
                
                // 使用fetch API从服务器获取文件内容
                fetch(filePath)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`文件加载失败: ${response.status} ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(data => {
                        // 设置编辑器内容
                        if (editor) {
                            const language = getMonacoLanguage(file);
                            editor.setValue(data);
                            monaco.editor.setModelLanguage(editor.getModel(), language);
                            language.textContent = getLanguageName(language);
                        }
                        
                        // 创建新标签页
                        createTab(tabId, folder, file, data);
                        
                        loadingIndicator.style.display = 'none';
                    })
                    .catch(error => {
                        showError('加载文件失败', error.message);
                        loadingIndicator.style.display = 'none';
                    });
            }
        
            // 创建标签页
            function createTab(tabId, folder, file, content) {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.id = `tab-${tabId}`;
                tab.setAttribute('data-tab-id', tabId);
                
                tab.innerHTML = `
                    <span class="tab-title">${file}</span>
                    <span class="tab-close"><i class="fas fa-times"></i></span>
                `;
                
                // 标签点击事件
                tab.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('tab-close') && !e.target.closest('.tab-close')) {
                        switchToTab(tabId);
                    }
                });
                
                // 关闭按钮事件
                const closeBtn = tab.querySelector('.tab-close');
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(tabId);
                });
                
                tabsContainer.appendChild(tab);
                
                // 保存标签信息
                tabs[tabId] = {
                    id: tabId,
                    folder: folder,
                    file: file,
                    content: content,
                    dirty: false
                };
                
                // 切换到新标签页
                switchToTab(tabId);
            }
        
            // 切换到指定标签页
            function switchToTab(tabId) {
                // 更新标签页状态
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById(`tab-${tabId}`).classList.add('active');
                
                // 更新编辑器内容
                const tab = tabs[tabId];
                if (editor && tab) {
                    editor.setValue(tab.content);
                    const language = getMonacoLanguage(tab.file);
                    monaco.editor.setModelLanguage(editor.getModel(), language);
                    language.textContent = getLanguageName(language);
                    
                    // 更新当前文件显示
                    currentFile.textContent = tab.file;
                }
                
                activeTabId = tabId;
            }
        
            // 更新标签页标题
            function updateTabTitle(tabId) {
                const tab = tabs[tabId];
                if (tab) {
                    const tabElement = document.getElementById(`tab-${tabId}`);
                    const titleElement = tabElement.querySelector('.tab-title');
                    
                    if (tab.dirty) {
                        tabElement.classList.add('tab-dirty');
                    } else {
                        tabElement.classList.remove('tab-dirty');
                    }
                }
            }
        
            // 关闭标签页
            function closeTab(tabId) {
                const tab = tabs[tabId];
                if (tab && tab.dirty) {
                    if (!confirm(`文件 ${tab.file} 已修改，确定要关闭吗？`)) {
                        return;
                    }
                }
                
                // 移除标签页元素
                const tabElement = document.getElementById(`tab-${tabId}`);
                if (tabElement) {
                    tabElement.remove();
                }
                
                // 从tabs对象中移除
                delete tabs[tabId];
                
                // 如果关闭的是当前活动标签页，切换到另一个标签页
                if (activeTabId === tabId) {
                    const remainingTabIds = Object.keys(tabs);
                    if (remainingTabIds.length > 0) {
                        switchToTab(remainingTabIds[0]);
                    } else {
                        // 没有打开的标签页，清空编辑器
                        editor.setValue('');
                        currentFile.textContent = '选择文件查看代码';
                        activeTabId = null;
                    }
                }
            }
        
            // 保存当前文件
            function saveCurrentFile() {
                if (!activeTabId || !editor) return;
                
                const tab = tabs[activeTabId];
                if (tab) {
                    const newContent = editor.getValue();
                    
                    // 更新标签页内容
                    tab.content = newContent;
                    tab.dirty = false;
                    updateTabTitle(activeTabId);
                    
                    // 如果是虚拟文件，保存到虚拟文件系统
                    if (virtualFileSystem[tab.folder] && virtualFileSystem[tab.folder].children[tab.file]) {
                        virtualFileSystem[tab.folder].children[tab.file].content = newContent;
                        saveVirtualFileSystem();
                    }
                    
                    showToast('文件已保存');
                }
            }
        
            // 显示错误函数
            function showError(title, message) {
                codeContent.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>${title}</h3>
                        <p>${message}</p>
                    </div>
                `;
                loadingIndicator.style.display = 'none';
            }
            
            // 显示空状态函数
            function showEmptyState(title, message) {
                codeContent.innerHTML = `
                    <div class="error">
                        <i class="fas fa-folder-open"></i>
                        <h3>${title}</h3>
                        <p>${message}</p>
                    </div>
                `;
                loadingIndicator.style.display = 'none';
            }
            
            // 根据文件扩展名获取Monaco语言ID
            function getMonacoLanguage(filename) {
                const extension = filename.split('.').pop().toLowerCase();
                const languageMap = {
                    'java': 'java',
                    'js': 'javascript',
                    'py': 'python',
                    'c': 'c',
                    'cpp': 'cpp',
                    'h': 'c',
                    'hpp': 'cpp',
                    'html': 'html',
                    'css': 'css',
                    'php': 'php',
                    'rb': 'ruby',
                    'go': 'go',
                    'rs': 'rust',
                    'xml': 'xml',
                    'json': 'json',
                    'md': 'markdown',
                    'ts': 'typescript',
                    'sql': 'sql',
                    'sh': 'shell',
                    'bat': 'bat',
                    'yml': 'yaml',
                    'yaml': 'yaml'
                };
                
                return languageMap[extension] || 'plaintext';
            }
        
            // 获取语言名称
            function getLanguageName(languageId) {
                const languageNames = {
                    'java': 'Java',
                    'javascript': 'JavaScript',
                    'python': 'Python',
                    'c': 'C',
                    'cpp': 'C++',
                    'html': 'HTML',
                    'css': 'CSS',
                    'php': 'PHP',
                    'ruby': 'Ruby',
                    'go': 'Go',
                    'rust': 'Rust',
                    'xml': 'XML',
                    'json': 'JSON',
                    'markdown': 'Markdown',
                    'typescript': 'TypeScript',
                    'sql': 'SQL',
                    'shell': 'Shell',
                    'bat': 'Batch',
                    'yaml': 'YAML',
                    'plaintext': 'Plain Text'
                };
                
                return languageNames[languageId] || languageId;
            }
            
            // 显示Toast提示
            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = isError ? 'toast error' : 'toast';
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        
            // 处理右键菜单操作
            function handleContextMenuAction(action) {
                switch (action) {
                    case 'newFile':
                        createNewFile();
                        break;
                    case 'newFolder':
                        createNewFolder();
                        break;
                    case 'rename':
                        renameFile();
                        break;
                    case 'delete':
                        deleteFile();
                        break;
                }
            }
        
            // 创建新文件
            function createNewFile() {
                const fileName = prompt('请输入新文件名:', 'newfile.txt');
                if (fileName && !containsPathTraversal(fileName)) {
                    // 添加到虚拟文件系统
                    if (!virtualFileSystem[currentFolder]) {
                        virtualFileSystem[currentFolder] = {
                            type: 'folder',
                            children: {}
                        };
                    }
                    
                    virtualFileSystem[currentFolder].children[fileName] = {
                        type: 'file',
                        content: ''
                    };
                    
                    saveVirtualFileSystem();
                    
                    // 添加到文件列表
                    currentFiles.push(fileName);
                    renderFileList(currentFiles);
                    
                    // 打开新文件
                    openFile(currentFolder, fileName, true);
                    
                    showToast(`已创建文件: ${fileName}`);
                }
            }
        
            // 创建新文件夹
            function createNewFolder() {
                const folderName = prompt('请输入新文件夹名称:', 'newfolder');
                if (folderName && !containsPathTraversal(folderName)) {
                    // 添加到虚拟文件系统
                    virtualFileSystem[folderName] = {
                        type: 'folder',
                        children: {}
                    };
                    
                    saveVirtualFileSystem();
                    
                    showToast(`已创建文件夹: ${folderName}`);
                    
                    // 刷新文件列表
                    refreshFileList();
                }
            }
        
            // 重命名文件
            function renameFile() {
                // 获取当前选中的文件
                const selectedFile = document.querySelector('.file-item.active');
                if (!selectedFile) return;
                
                const oldFileName = selectedFile.getAttribute('data-file');
                const newFileName = prompt('请输入新的文件名:', oldFileName);
                
                if (newFileName && !containsPathTraversal(newFileName)) {
                    // 更新虚拟文件系统
                    if (virtualFileSystem[currentFolder] && virtualFileSystem[currentFolder].children[oldFileName]) {
                        virtualFileSystem[currentFolder].children[newFileName] = virtualFileSystem[currentFolder].children[oldFileName];
                        delete virtualFileSystem[currentFolder].children[oldFileName];
                        saveVirtualFileSystem();
                        
                        // 更新文件列表
                        const index = currentFiles.indexOf(oldFileName);
                        if (index !== -1) {
                            currentFiles[index] = newFileName;
                            renderFileList(currentFiles);
                        }
                        
                        showToast(`已重命名: ${oldFileName} -> ${newFileName}`);
                    }
                }
            }
        
            // 删除文件
            function deleteFile() {
                // 获取当前选中的文件
                const selectedFile = document.querySelector('.file-item.active');
                if (!selectedFile) return;
                
                const fileName = selectedFile.getAttribute('data-file');
                if (confirm(`确定要删除文件 "${fileName}" 吗？`)) {
                    // 从虚拟文件系统中删除
                    if (virtualFileSystem[currentFolder] && virtualFileSystem[currentFolder].children[fileName]) {
                        delete virtualFileSystem[currentFolder].children[fileName];
                        saveVirtualFileSystem();
                        
                        // 从文件列表中删除
                        const index = currentFiles.indexOf(fileName);
                        if (index !== -1) {
                            currentFiles.splice(index, 1);
                            renderFileList(currentFiles);
                        }
                        
                        showToast(`已删除文件: ${fileName}`);
                    }
                }
            }
        
            // 刷新文件列表
            function refreshFileList() {
                if (fileParam) {
                    // 从URL参数加载
                    const files = fileParam.substring(separatorIndex + 1).split(',');
                    currentFiles = files;
                    renderFileList(files);
                } else {
                    // 从虚拟文件系统加载
                    loadVirtualFileSystem();
                }
                
                showToast('文件列表已刷新');
            }
        
            // 执行搜索
            function performSearch() {
                const searchText = searchInput.value;
                if (!searchText) return;
                
                const caseSensitive = document.getElementById('caseSensitive').checked;
                const wholeWord = document.getElementById('wholeWord').checked;
                const useRegex = document.getElementById('useRegex').checked;
                
                if (editor) {
                    const model = editor.getModel();
                    const matches = model.findMatches(
                        searchText,
                        false, // 只搜索当前选择
                        caseSensitive,
                        useRegex,
                        null, // 单词分隔符
                        wholeWord
                    );
                    
                    // 显示搜索结果
                    searchResults.innerHTML = '';
                    
                    if (matches.length === 0) {
                        searchResults.innerHTML = '<div class="search-result-item">未找到匹配项</div>';
                    } else {
                        matches.forEach((match, index) => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.innerHTML = `
                                第${match.range.startLineNumber}行: ${model.getLineContent(match.range.startLineNumber)}
                            `;
                            
                            resultItem.addEventListener('click', () => {
                                editor.setPosition({
                                    lineNumber: match.range.startLineNumber,
                                    column: match.range.startColumn
                                });
                                editor.revealLineInCenter(match.range.startLineNumber);
                                editor.focus();
                            });
                            
                            searchResults.appendChild(resultItem);
                        });
                    }
                }
            }
        
            // 执行替换
            function performReplace() {
                const searchText = searchInput.value;
                const replaceText = replaceInput.value;
                
                if (!searchText) return;
                
                if (editor) {
                    const selection = editor.getSelection();
                    const selectedText = editor.getModel().getValueInRange(selection);
                    
                    const caseSensitive = document.getElementById('caseSensitive').checked;
                    const wholeWord = document.getElementById('wholeWord').checked;
                    const useRegex = document.getElementById('useRegex').checked;
                    
                    // 检查选中的文本是否匹配搜索文本
                    let isMatch = false;
                    if (useRegex) {
                        const regex = new RegExp(searchText, caseSensitive ? 'g' : 'gi');
                        isMatch = regex.test(selectedText);
                    } else {
                        if (caseSensitive) {
                            isMatch = selectedText === searchText;
                        } else {
                            isMatch = selectedText.toLowerCase() === searchText.toLowerCase();
                        }
                    }
                    
                    if (isMatch) {
                        editor.executeEdits('', [{
                            range: selection,
                            text: replaceText
                        }]);
                    }
                    
                    // 查找下一个匹配项
                    performSearch();
                }
            }
        
            // 执行全部替换
            function performReplaceAll() {
                const searchText = searchInput.value;
                const replaceText = replaceInput.value;
                
                if (!searchText) return;
                
                const caseSensitive = document.getElementById('caseSensitive').checked;
                const wholeWord = document.getElementById('wholeWord').checked;
                const useRegex = document.getElementById('useRegex').checked;
                
                if (editor) {
                    const model = editor.getModel();
                    const matches = model.findMatches(
                        searchText,
                        false, // 只搜索当前选择
                        caseSensitive,
                        useRegex,
                        null, // 单词分隔符
                        wholeWord
                    );
                    
                    // 按行号降序排序，这样替换时不会影响后续匹配的位置
                    matches.sort((a, b) => b.range.startLineNumber - a.range.startLineNumber);
                    
                    // 执行替换
                    editor.executeEdits('', matches.map(match => ({
                        range: match.range,
                        text: replaceText
                    })));
                    
                    showToast(`已替换 ${matches.length} 处匹配项`);
                }
            }
        
            // 显示命令面板
            function showCommandPalette() {
                commandPalette.style.display = 'block';
                overlay.style.display = 'block';
                commandInput.value = '';
                commandInput.focus();
                
                // 显示所有命令
                const commandItems = document.querySelectorAll('.command-item');
                commandItems.forEach(item => {
                    item.style.display = 'flex';
                });
                
                // 激活第一个命令
                if (commandItems.length > 0) {
                    commandItems.forEach(item => item.classList.remove('active'));
                    commandItems[0].classList.add('active');
                }
            }
        
            // 隐藏命令面板
            function hideCommandPalette() {
                commandPalette.style.display = 'none';
                overlay.style.display = 'none';
            }
        
            // 过滤命令
            function filterCommands() {
                const filterText = commandInput.value.toLowerCase();
                const commandItems = document.querySelectorAll('.command-item');
                let hasVisibleItems = false;
                
                commandItems.forEach((item, index) => {
                    const title = item.querySelector('.command-title').textContent.toLowerCase();
                    const desc = item.querySelector('.command-desc').textContent.toLowerCase();
                    
                    if (title.includes(filterText) || desc.includes(filterText)) {
                        item.style.display = 'flex';
                        if (!hasVisibleItems) {
                            item.classList.add('active');
                            hasVisibleItems = true;
                        } else {
                            item.classList.remove('active');
                        }
                    } else {
                        item.style.display = 'none';
                        item.classList.remove('active');
                    }
                });
                
                // 如果没有可见项，激活第一个可见项
                if (!hasVisibleItems && commandItems.length > 0) {
                    for (let i = 0; i < commandItems.length; i++) {
                        if (commandItems[i].style.display !== 'none') {
                            commandItems[i].classList.add('active');
                            break;
                        }
                    }
                }
            }
        
            // 执行命令
            function executeCommand(command) {
                switch (command) {
                    case 'file.newFile':
                        createNewFile();
                        break;
                    case 'file.save':
                        saveCurrentFile();
                        break;
                    case 'editor.toggleTheme':
                        toggleTheme();
                        break;
                    case 'view.toggleSidebar':
                        fileNavigator.classList.toggle('hidden');
                        document.querySelector('.activity-bar').classList.toggle('hidden');
                        break;
                    case 'search.find':
                        searchPanel.classList.add('active');
                        searchInput.focus();
                        break;
                }
            }
        
            // 加载保存的主题偏好
            const savedTheme = localStorage.getItem('editor_theme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', currentTheme);
                themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            }
        });
    </script>
</body>

</html>